<html>

<head>
  <title>Pixel Game</title>
  <!-- Bulma -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.css.map">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css">
  <!-- Icons -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp"
    crossorigin="anonymous">

  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://rawgit.com/kawanet/msgpack-lite/master/dist/msgpack.min.js"></script>
  <script src="config.js"></script>
  <script src="api.js"></script>

</head>

<body>

  <div class="columns is-horizontal-center box">
    <div class="column is-narrow">
      <div class="title has-text-centered">
        <i class="fas fa-gamepad"></i>
        Pixel Game
        <i class="fas fa-gamepad"></i>
      </div>
      <div id="canvasBorder">
        <canvas id="canvas" style=" border:1px solid #000000"></canvas>
      </div>
    </div>
  </div>


  <script>
    let scale = 4;
    let gameInfo = JSON.parse(localStorage.getItem('game-info'));
    let ctx, canvas;
    let boardCache;
    var originx = 0;
    var originy = 0;



    window.onload = function () {
      canvas = document.getElementById('canvas');
      canvas.addEventListener('mousedown', onDown, false);
      canvas.width = gameInfo.board.xWidth * scale;
      canvas.height = gameInfo.board.yWidth * scale;
      ctx = canvas.getContext('2d');
      document.getElementById("canvasBorder").style.transform = "scale(1,1)";
      getBoard()
        .then((board) => {
          boardCache = board;
          drawBoard(board);
        });





      canvas.onmousewheel = function (event) {
        console.log("trigged");
        if (event.deltaY < 0) {
          document.getElementById("canvasBorder").style.transform = "scale(2,2)";
        } else {
          document.getElementById("canvasBorder").style.transform = "scale(1,1)";
        }
      }
    }






    function onDown(event) {
      const { x, y } = getCanvasClickLocation(event);
      console.log(x, y);

      drawPixel(x, y, gameInfo.colors[7].hex);

      place(x, y, 6)
        .then((pixel) => {
          console.log(pixel);
        }).catch((err) => {
          if (err.response.status === 400) {
            console.log("Too Fast!!!");
          }
          if (err.response.status === 560) {
            console.log("Server is down:");
            console.log(err);
          }
        });
    }













    function drawPixel(x, y, color) {
      ctx.fillStyle = color;
      ctx.fillRect(x * scale, y * scale, scale, scale);
    }

    function drawBoard(pixels) {
      console.log('Drawing', pixels);
      console.log('Game info', gameInfo);

      let i = 0;
      for (const pixel of pixels) {
        x = (i % 200);
        y = ((i - (i % 200)) / 200);

        drawPixel(x, y, gameInfo.colors[pixel].hex);
        i++;
      }
    }

    function getCanvasClickLocation(event) {
      var rect = canvas.getBoundingClientRect();
      var x = event.clientX - rect.left;
      var y = event.clientY - rect.top;
      return { x: x / scale, y: y / scale };
    }


    const ws = new WebSocket(`ws://localhost:3001`);
    ws.binaryType = 'arraybuffer'

    ws.addEventListener('open', () => {
      console.log('Websocket Connection Opened');
    })

    ws.addEventListener('message', ({ data }) => {
      const unpacked = msgpack.decode(new Uint8Array(data));
      console.log('Websocket Message', unpacked);
    });

    document.getElementById('place-pixel-button').addEventListener('click', () => {
      place(1, 1, 1)
        .then((pixel) => {
          console.log(pixel);
        }).catch((err) => {
          console.error(err);
        });
    })

    document.getElementById('get-board-button').addEventListener('click', () => {
      getBoard()
        .then((board) => {
          boardCache = board;
          drawBoard(board);
        });
    });

    document.getElementById('get-game-info').addEventListener('click', () => {
      var item = localStorage.getItem('game-info');
      console.log(JSON.parse(item));
    })
  </script>


  <style>
    .mt {
      margin-top: 0.5rem !important;
    }

    .is-horizontal-center {
      justify-content: center;
    }
  </style>

</body>

</html>