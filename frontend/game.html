<html>

<head>
  <title>Game</title>
</head>

<body>
  <h2>This is the game yall</h2>
  <button id="place-pixel-button">Place Pixel</button>
  <button id="get-board-button">Get Board</button>
  <button id="get-game-info">Get Game Info</button>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://rawgit.com/kawanet/msgpack-lite/master/dist/msgpack.min.js"></script>
  <script src="config.js"></script>
  <script src="api.js"></script>
  <canvas id="canvas" style="border:1px solid #000000"></canvas>

  <script>
    const scale = 4;
    let gameInfo = JSON.parse(localStorage.getItem('game-info'));
    let ctx, canvas;

    window.onload = function () {
      canvas = document.getElementById('canvas');
      canvas.addEventListener('mousedown', onDown, false);
      canvas.width = gameInfo.board.xWidth * scale;
      canvas.height = gameInfo.board.yWidth * scale;

      ctx = canvas.getContext('2d');
    }

    function drawPixel(x, y, color) {
      ctx.fillStyle = color;
      ctx.fillRect(x * scale, y * scale, scale, scale);
    }

    function drawBoard(pixels) {
      console.log('Drawing', pixels);
      console.log('Game info', gameInfo);

      let i = 0;
      for (const pixel of pixels) {
        x = (i % 200);
        y = ((i - (i % 200)) / 200);

        drawPixel(x, y, gameInfo.colors[pixel].hex);
        i++;
      }
    }

    function getCanvasClickLocation(event) {
      var rect = canvas.getBoundingClientRect();
      var x = event.clientX - rect.left;
      var y = event.clientY - rect.top;
      return { x: x / scale, y: y / scale };
    }

    function onDown(event) {
      const { x, y } = getCanvasClickLocation(event);
      console.log(x, y);

      drawPixel(x, y, gameInfo.colors[7].hex);

      place(x, y, 6)
        .then((pixel) => {
          console.log(pixel);
        }).catch((err) => {
          if (err.response.status === 400) {
            console.log("Too Fast!!!");
          }
          if (err.response.status === 560) {
            console.log("Server is down:");
            console.log(err);
          }
        });
    }

    const ws = new WebSocket(`ws://localhost:3001`);
    ws.binaryType = 'arraybuffer'

    ws.addEventListener('open', () => {
      console.log('Websocket Connection Opened');
    })

    ws.addEventListener('message', ({ data }) => {
      const unpacked = msgpack.decode(new Uint8Array(data));
      console.log('Websocket Message', unpacked);
    });

    document.getElementById('place-pixel-button').addEventListener('click', () => {
      place(1, 1, 1)
        .then((pixel) => {
          console.log(pixel);
        }).catch((err) => {
          console.error(err);
        });
    })

    document.getElementById('get-board-button').addEventListener('click', () => {
      getBoard()
        .then((board) => {
          drawBoard(board);
        });
    });

    document.getElementById('get-game-info').addEventListener('click', () => {
      var item = localStorage.getItem('game-info');
      console.log(JSON.parse(item));
    })
  </script>
</body>

</html>